<!DOCTYPE html>
<!--
  Visual C Code Editor
  Copyright (c) 2024 - Open Source Project
  Licensed under the same terms as the Hello-World repository
  
  A web-based visual programming interface for creating C code using drag-and-drop blocks.
  No external services or analytics are used - completely self-contained and privacy-focused.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual C Code Editor</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem;
            color: white;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .editor-container {
            display: flex;
            flex: 1;
            gap: 1rem;
            padding: 1rem;
        }

        .block-palette {
            width: 250px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            role: region;
            aria-label: "Programming blocks palette";
        }

        .palette-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 1rem;
            text-align: center;
        }

        .block-category {
            margin-bottom: 1.5rem;
        }

        .category-title {
            font-weight: 600;
            color: #555;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .canvas {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
            min-height: 400px;
            overflow: auto;
            role: region;
            aria-label: "Visual programming canvas";
        }

        .canvas-content {
            padding: 2rem;
            min-height: 100%;
        }

        .canvas-title {
            text-align: center;
            color: #666;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .output-panel {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .code-output, .preview-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            flex: 1;
        }

        .panel-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
            text-align: center;
        }

        .code-display {
            background: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #4a5568;
            role: textbox;
            aria-label: "Generated C code";
            aria-readonly: "true";
        }

        .block {
            background: #4299e1;
            color: white;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            cursor: grab;
            user-select: none;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            position: relative;
            role: button;
            tabindex: 0;
            aria-label: "Draggable programming block";
        }

        .block:hover {
            background: #3182ce;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }

        .block:focus {
            outline: 2px solid #fff;
            outline-offset: 2px;
        }

        .block:active {
            cursor: grabbing;
        }

        .block.statement {
            background: #38a169;
        }

        .block.statement:hover {
            background: #2f855a;
        }

        .block.control {
            background: #ed8936;
        }

        .block.control:hover {
            background: #dd6b20;
        }

        .block.function {
            background: #9f7aea;
        }

        .block.function:hover {
            background: #805ad5;
        }

        .placed-block {
            background: #4299e1;
            color: white;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            cursor: move;
            position: relative;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            role: button;
            tabindex: 0;
            aria-label: "Placed programming block - press Delete to remove";
        }

        .placed-block:hover {
            border-color: #3182ce;
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }

        .placed-block:focus {
            outline: 2px solid #fff;
            outline-offset: 2px;
        }

        .placed-block.statement {
            background: #38a169;
        }

        .placed-block.control {
            background: #ed8936;
        }

        .placed-block.function {
            background: #9f7aea;
        }

        .drop-zone {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            color: #718096;
            min-height: 100px;
            margin: 1rem 0;
            transition: all 0.2s ease;
            role: region;
            aria-label: "Drop zone for programming blocks";
        }

        .drop-zone.drag-over {
            border-color: #4299e1;
            background: rgba(66, 153, 225, 0.1);
            color: #2d3748;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            tabindex: 0;
        }

        .btn:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }

        .btn:focus {
            outline: 2px solid #fff;
            outline-offset: 2px;
        }

        .btn.success {
            background: #38a169;
        }

        .btn.success:hover {
            background: #2f855a;
        }

        .btn.danger {
            background: #e53e3e;
        }

        .btn.danger:hover {
            background: #c53030;
        }

        .block-input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            color: white;
            font-size: 0.9rem;
            margin: 0.25rem;
        }

        .block-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .block-input:focus {
            outline: 2px solid rgba(255, 255, 255, 0.8);
            outline-offset: 1px;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            border-left: 4px solid #e53e3e;
            role: alert;
        }

        .success-message {
            background: #c6f6d5;
            color: #2f855a;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            border-left: 4px solid #38a169;
            role: alert;
        }

        .accessibility-note {
            background: #bee3f8;
            color: #2c5aa0;
            padding: 0.5rem;
            border-radius: 4px;
            margin: 1rem 0;
            font-size: 0.8rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            .editor-container {
                flex-direction: column;
            }
            
            .block-palette, .output-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Visual C Code Editor</h1>
        <p>Drag and drop blocks to create C code, then export to hello.c</p>
        <div class="accessibility-note">
            Keyboard users: Use Tab to navigate, Enter/Space to select blocks, Delete to remove placed blocks
        </div>
    </div>

    <div class="editor-container">
        <!-- Block Palette -->
        <div class="block-palette">
            <h3 class="palette-title">Programming Blocks</h3>
            
            <div class="block-category">
                <h4 class="category-title">Basic Statements</h4>
                <div class="block statement" draggable="true" data-type="printf" tabindex="0" role="button" aria-label="Print statement block">
                    <strong>Print</strong><br>
                    printf("<input type="text" class="block-input" placeholder="text" value="Hello world!" aria-label="Print text">")
                </div>
                <div class="block statement" draggable="true" data-type="variable" tabindex="0" role="button" aria-label="Variable declaration block">
                    <strong>Variable</strong><br>
                    <select class="block-input" style="width: auto;" aria-label="Variable type">
                        <option>int</option>
                        <option>char</option>
                        <option>float</option>
                        <option>double</option>
                    </select>
                    <input type="text" class="block-input" placeholder="name" value="x" aria-label="Variable name">
                    = <input type="text" class="block-input" placeholder="value" value="0" aria-label="Variable value">
                </div>
            </div>

            <div class="block-category">
                <h4 class="category-title">Control Flow</h4>
                <div class="block control" draggable="true" data-type="if" tabindex="0" role="button" aria-label="If statement block">
                    <strong>If Statement</strong><br>
                    if (<input type="text" class="block-input" placeholder="condition" value="x > 0" aria-label="If condition">)
                </div>
                <div class="block control" draggable="true" data-type="for" tabindex="0" role="button" aria-label="For loop block">
                    <strong>For Loop</strong><br>
                    for (int <input type="text" class="block-input" placeholder="var" value="i" aria-label="Loop variable"> = <input type="text" class="block-input" placeholder="start" value="0" aria-label="Start value">; 
                    <input type="text" class="block-input" placeholder="var" value="i" aria-label="Condition variable"> < <input type="text" class="block-input" placeholder="end" value="10" aria-label="End value">; 
                    <input type="text" class="block-input" placeholder="var" value="i" aria-label="Increment variable">++)
                </div>
            </div>

            <div class="block-category">
                <h4 class="category-title">Functions</h4>
                <div class="block function" draggable="true" data-type="main" tabindex="0" role="button" aria-label="Main function block">
                    <strong>Main Function</strong><br>
                    int main()
                </div>
                <div class="block function" draggable="true" data-type="include" tabindex="0" role="button" aria-label="Include header block">
                    <strong>Include</strong><br>
                    #include &lt;<input type="text" class="block-input" placeholder="header" value="stdio.h" aria-label="Header file name">&gt;
                </div>
            </div>
        </div>

        <!-- Canvas -->
        <div class="canvas">
            <div class="canvas-content">
                <h3 class="canvas-title">Drop blocks here to build your program</h3>
                <div id="drop-zone" class="drop-zone" role="region" aria-label="Programming canvas - drop blocks here">
                    <p>Start by dragging blocks from the left panel or using keyboard navigation</p>
                </div>
                
                <div class="controls">
                    <button class="btn" onclick="generateCode()" tabindex="0" aria-label="Generate C code from blocks">Generate Code</button>
                    <button class="btn success" onclick="exportToFile()" tabindex="0" aria-label="Export generated code as hello.c file">Export to hello.c</button>
                    <button class="btn danger" onclick="clearCanvas()" tabindex="0" aria-label="Clear all blocks from canvas">Clear All</button>
                </div>
            </div>
        </div>

        <!-- Output Panel -->
        <div class="output-panel">
            <div class="code-output">
                <h3 class="panel-title">Generated C Code</h3>
                <div id="code-display" class="code-display" role="textbox" aria-label="Generated C code output" aria-readonly="true">// Your generated C code will appear here</div>
            </div>
            
            <div class="preview-panel">
                <h3 class="panel-title">Actions</h3>
                <button class="btn" onclick="testCompile()" style="width: 100%; margin-bottom: 0.5rem;" tabindex="0" aria-label="Test compile the generated code">Test Compile</button>
                <button class="btn" onclick="runProgram()" style="width: 100%; margin-bottom: 0.5rem;" tabindex="0" aria-label="Get instructions to run the program">Run Program</button>
                <div id="output-messages" role="region" aria-label="Status messages" aria-live="polite"></div>
            </div>
        </div>
    </div>

    <script>
        'use strict';
        
        // Global state
        let draggedElement = null;
        let blockCounter = 0;
        let placedBlocks = [];

        // Security: Input sanitization functions
        function escapeForC(input) {
            if (typeof input !== 'string') {
                return String(input);
            }
            return input
                .replace(/\\/g, '\\\\')    // Escape backslashes
                .replace(/"/g, '\\"')      // Escape quotes
                .replace(/\n/g, '\\n')     // Escape newlines
                .replace(/\r/g, '\\r')     // Escape carriage returns
                .replace(/\t/g, '\\t')     // Escape tabs
                .replace(/%/g, '%%');      // Escape printf format specifiers
        }

        function validateCIdentifier(input) {
            // Allow only valid C identifiers: letters, digits, underscore, starting with letter or underscore
            const identifier = String(input).trim();
            const validPattern = /^[a-zA-Z_][a-zA-Z0-9_]*$/;
            return validPattern.test(identifier) ? identifier : 'defaultVar';
        }

        function validateCExpression(input) {
            // Basic validation for C expressions - allow common patterns but escape dangerous characters
            const expression = String(input).trim();
            // Remove potentially dangerous characters but allow basic C operators
            const sanitized = expression.replace(/[^\w\s+\-*/<>=!&|()[\].,]/g, '');
            return sanitized || '1'; // Default to '1' if empty
        }

        // Initialize drag and drop
        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
            setupKeyboardNavigation();
            setupAccessibility();
        });

        function setupDragAndDrop() {
            // Handle dragging from palette
            document.querySelectorAll('.block').forEach(block => {
                block.addEventListener('dragstart', function(e) {
                    draggedElement = this;
                    e.dataTransfer.effectAllowed = 'copy';
                });

                // Keyboard support for palette blocks
                block.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        addBlockToCanvas(this);
                    }
                });
            });

            // Handle drop zone
            const dropZone = document.getElementById('drop-zone');
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
                this.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                if (draggedElement) {
                    addBlockToCanvas(draggedElement);
                    draggedElement = null;
                }
            });
        }

        function setupKeyboardNavigation() {
            document.addEventListener('keydown', function(e) {
                // Global keyboard shortcuts
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 's':
                            e.preventDefault();
                            exportToFile();
                            break;
                        case 'r':
                            e.preventDefault();
                            generateCode();
                            break;
                    }
                }
            });
        }

        function setupAccessibility() {
            // Announce important state changes to screen readers
            const announcer = document.createElement('div');
            announcer.setAttribute('aria-live', 'polite');
            announcer.setAttribute('aria-atomic', 'true');
            announcer.style.position = 'absolute';
            announcer.style.left = '-10000px';
            announcer.id = 'accessibility-announcer';
            document.body.appendChild(announcer);
        }

        function announceToScreenReader(message) {
            const announcer = document.getElementById('accessibility-announcer');
            if (announcer) {
                announcer.textContent = message;
            }
        }

        function addBlockToCanvas(sourceBlock) {
            blockCounter++;
            const blockType = sourceBlock.dataset.type;
            const blockCategory = sourceBlock.classList.contains('statement') ? 'statement' : 
                                 sourceBlock.classList.contains('control') ? 'control' : 'function';

            const placedBlock = document.createElement('div');
            placedBlock.className = `placed-block ${blockCategory}`;
            placedBlock.draggable = true;
            placedBlock.dataset.type = blockType;
            placedBlock.dataset.id = blockCounter;
            placedBlock.setAttribute('tabindex', '0');
            placedBlock.setAttribute('role', 'button');
            placedBlock.setAttribute('aria-label', `${blockType} block - press Delete to remove`);
            
            // Clone the content from the source block
            placedBlock.innerHTML = sourceBlock.innerHTML;
            
            // Add remove button
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = 'Ã—';
            removeBtn.setAttribute('aria-label', `Remove ${blockType} block`);
            removeBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.2); border: none; color: white; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 14px; line-height: 1;';
            removeBtn.onclick = function(e) {
                e.stopPropagation();
                removeBlock(placedBlock);
            };
            placedBlock.appendChild(removeBtn);

            // Keyboard support for placed blocks
            placedBlock.addEventListener('keydown', function(e) {
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    e.preventDefault();
                    removeBlock(placedBlock);
                } else if (e.key === 'ArrowUp' && e.ctrlKey) {
                    e.preventDefault();
                    moveBlockUp(placedBlock);
                } else if (e.key === 'ArrowDown' && e.ctrlKey) {
                    e.preventDefault();
                    moveBlockDown(placedBlock);
                }
            });

            // Add to placed blocks array
            placedBlocks.push({
                id: blockCounter,
                type: blockType,
                category: blockCategory,
                element: placedBlock
            });

            // Insert into canvas
            const dropZone = document.getElementById('drop-zone');
            dropZone.parentNode.insertBefore(placedBlock, dropZone.nextSibling);

            // Update drop zone text if this is the first block
            if (placedBlocks.length === 1) {
                dropZone.innerHTML = '<p>Add more blocks or drag to reorder</p>';
            }

            // Make placed blocks sortable
            setupBlockSorting(placedBlock);
            
            // Auto-generate code
            generateCode();
            
            // Announce to screen readers
            announceToScreenReader(`${blockType} block added to canvas`);
        }

        function moveBlockUp(blockElement) {
            const blockId = parseInt(blockElement.dataset.id);
            const index = placedBlocks.findIndex(b => b.id === blockId);
            
            if (index > 0) {
                // Swap in array
                [placedBlocks[index-1], placedBlocks[index]] = [placedBlocks[index], placedBlocks[index-1]];
                
                // Move in DOM
                blockElement.parentNode.insertBefore(blockElement, placedBlocks[index-1].element);
                
                generateCode();
                announceToScreenReader('Block moved up');
            }
        }

        function moveBlockDown(blockElement) {
            const blockId = parseInt(blockElement.dataset.id);
            const index = placedBlocks.findIndex(b => b.id === blockId);
            
            if (index < placedBlocks.length - 1) {
                // Swap in array
                [placedBlocks[index], placedBlocks[index+1]] = [placedBlocks[index+1], placedBlocks[index]];
                
                // Move in DOM
                blockElement.parentNode.insertBefore(placedBlocks[index+1].element, blockElement);
                
                generateCode();
                announceToScreenReader('Block moved down');
            }
        }

        function setupBlockSorting(block) {
            block.addEventListener('dragstart', function(e) {
                draggedElement = this;
                e.dataTransfer.effectAllowed = 'move';
            });

            block.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            block.addEventListener('drop', function(e) {
                e.preventDefault();
                if (draggedElement && draggedElement !== this && draggedElement.classList.contains('placed-block')) {
                    // Reorder blocks
                    const draggedIndex = placedBlocks.findIndex(b => b.element === draggedElement);
                    const targetIndex = placedBlocks.findIndex(b => b.element === this);
                    
                    if (draggedIndex !== -1 && targetIndex !== -1) {
                        // Move in DOM
                        if (draggedIndex < targetIndex) {
                            this.parentNode.insertBefore(draggedElement, this.nextSibling);
                        } else {
                            this.parentNode.insertBefore(draggedElement, this);
                        }
                        
                        // Update array
                        const [movedBlock] = placedBlocks.splice(draggedIndex, 1);
                        placedBlocks.splice(targetIndex, 0, movedBlock);
                        
                        generateCode();
                        announceToScreenReader('Blocks reordered');
                    }
                }
                draggedElement = null;
            });
        }

        function removeBlock(blockElement) {
            const blockId = parseInt(blockElement.dataset.id);
            const blockType = blockElement.dataset.type;
            placedBlocks = placedBlocks.filter(b => b.id !== blockId);
            blockElement.remove();
            
            // Update drop zone if no blocks left
            if (placedBlocks.length === 0) {
                document.getElementById('drop-zone').innerHTML = '<p>Start by dragging blocks from the left panel or using keyboard navigation</p>';
            }
            
            generateCode();
            announceToScreenReader(`${blockType} block removed`);
        }

        // Enhanced and secure code generation
        function generateCode() {
            let code = '';
            let hasInclude = false;
            let hasMain = false;
            let mainContent = '';
            let declarations = '';

            // Process blocks in order
            placedBlocks.forEach(block => {
                const element = block.element;
                const inputs = element.querySelectorAll('.block-input');
                
                switch(block.type) {
                    case 'include':
                        const header = inputs[0] ? validateCIdentifier(inputs[0].value || 'stdio.h') : 'stdio.h';
                        code += `#include <${header}>\n`;
                        hasInclude = true;
                        break;
                        
                    case 'variable':
                        const varType = element.querySelector('select') ? element.querySelector('select').value : 'int';
                        const varName = inputs[1] ? validateCIdentifier(inputs[1].value || 'x') : 'x';
                        const varValue = inputs[2] ? validateCExpression(inputs[2].value || '0') : '0';
                        declarations += `    ${varType} ${varName} = ${varValue};\n`;
                        break;
                        
                    case 'main':
                        hasMain = true;
                        break;
                        
                    case 'printf':
                        const text = inputs[0] ? escapeForC(inputs[0].value || 'Hello world!') : 'Hello world!';
                        mainContent += `    printf("${text}\\n");\n`;
                        break;
                        
                    case 'if':
                        const condition = inputs[0] ? validateCExpression(inputs[0].value || 'x > 0') : 'x > 0';
                        mainContent += `    if (${condition}) {\n        /* Add statements here */\n    }\n`;
                        break;
                        
                    case 'for':
                        const loopVar = inputs[0] ? validateCIdentifier(inputs[0].value || 'i') : 'i';
                        const startVal = inputs[1] ? validateCExpression(inputs[1].value || '0') : '0';
                        const endVar = inputs[2] ? validateCIdentifier(inputs[2].value || 'i') : 'i';
                        const endVal = inputs[3] ? validateCExpression(inputs[3].value || '10') : '10';
                        const incVar = inputs[4] ? validateCIdentifier(inputs[4].value || 'i') : 'i';
                        mainContent += `    for (int ${loopVar} = ${startVal}; ${endVar} < ${endVal}; ${incVar}++) {\n        /* Add statements here */\n    }\n`;
                        break;
                }
            });

            // Build complete program
            if (!hasInclude) {
                code += '#include <stdio.h>\n';
            }
            
            code += '\n';
            
            if (hasMain || placedBlocks.length > 0) {
                code += 'int main() {\n';
                code += declarations;
                code += mainContent;
                if (!mainContent.includes('printf')) {
                    code += '    printf("Hello world!\\n");\n';
                }
                code += '    return 0;\n';
                code += '}\n';
            } else {
                code += 'int main() {\n    printf("Hello world!\\n");\n    return 0;\n}\n';
            }

            document.getElementById('code-display').textContent = code;
            return code;
        }

        function exportToFile() {
            const code = generateCode();
            
            try {
                // Create a secure download link
                const blob = new Blob([code], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'hello.c';
                a.setAttribute('aria-label', 'Download generated C code as hello.c');
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showMessage('Generated code exported as hello.c! You can now compile it with: gcc -o hello hello.c', 'success');
                announceToScreenReader('Code exported successfully as hello.c');
            } catch (error) {
                showMessage('Error exporting file: ' + error.message, 'error');
                announceToScreenReader('Error exporting file');
            }
        }

        function clearCanvas() {
            if (confirm('Are you sure you want to clear all blocks?')) {
                placedBlocks.forEach(block => block.element.remove());
                placedBlocks = [];
                blockCounter = 0;
                document.getElementById('drop-zone').innerHTML = '<p>Start by dragging blocks from the left panel or using keyboard navigation</p>';
                document.getElementById('code-display').textContent = '// Your generated C code will appear here';
                clearMessages();
                announceToScreenReader('Canvas cleared');
            }
        }

        function testCompile() {
            const code = generateCode();
            // Basic syntax validation
            const hasMain = code.includes('int main()');
            const hasInclude = code.includes('#include');
            const hasReturnZero = code.includes('return 0;');
            
            if (hasMain && hasInclude && hasReturnZero) {
                showMessage('Code syntax appears valid! Download and compile with: gcc -Wall -Wextra -o hello hello.c', 'success');
            } else {
                showMessage('Warning: Generated code may be missing required elements (main function, includes, or return statement)', 'error');
            }
        }

        function runProgram() {
            showMessage('Download the generated hello.c file and run: gcc -Wall -Wextra -o hello hello.c && ./hello', 'success');
        }

        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('output-messages');
            const messageEl = document.createElement('div');
            messageEl.className = type === 'success' ? 'success-message' : 'error-message';
            messageEl.textContent = message;
            messageEl.setAttribute('role', 'alert');
            messagesDiv.appendChild(messageEl);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 5000);
        }

        function clearMessages() {
            document.getElementById('output-messages').innerHTML = '';
        }

        // Prevent form submission on enter in input fields
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.classList.contains('block-input')) {
                e.preventDefault();
                generateCode();
            }
        });

        // Auto-generate code when inputs change
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('block-input')) {
                generateCode();
            }
        });

        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('block-input')) {
                generateCode();
            }
        });

        // Expose generateCode function for testing
        window.VisualEditor = {
            generateCode: generateCode,
            escapeForC: escapeForC,
            validateCIdentifier: validateCIdentifier,
            validateCExpression: validateCExpression
        };
    </script>
</body>
</html>